# CHAPTER 04 SQL 고급	

## 01 내장함수	

### SQL 내장함수	
- SQL 내장 함수는 상수나 속성 이름을 입력 갑승로 받아 단일 값을 결과로 반환한다.	
- SELECT, WHERE, UPDATE 절 등에서 모두 사용 가능	

### MySQL에서 제공하는 내장 함수	
| 구분 | | 함수 |	
| --- | --- | --- |	
| 단일행함수 | 숫자함수 | ABS, CEIL, COS, EXP, FLOOR, LN, LOG, MOD, POWER, RAND, ROUND, SIGN, TRUNCATE |	
| | 문자함수(문자 변환)  | CHAR, CONCAT, LEFT, RIGHT, LOWER, UPPER, LPAD, RPAD, LTRIM, RTRIM, REPLACE, REVERSE, RIGHT, SUBSTR, TRIM |	
| | 문자 함수(숫자 변환) | ASCII, INSTR, LENGTH |	
| | 날짜, 시간 함수 | ADDDATE, CURRENT_DATE, DATE, DATEDIFF, DAYNAME, LAST_DAY, SYSDATE, TIME |	
| | 변환 함수 | CAST, CONVERT, DATE_FORMAT, STR_TO_DATE |	
| | 정보 함수 | DATABASE, SCHEMA, ROW_COUNR, USER, VERSION |	
| | NULL 관련 함수 | COALESCE, ISNULL, IFNULL, NULLIF |	
| 집계 함수 | | AVG, COUNT, MAX, MIN, STD, STDDEV, SUM |	
| 윈도우 함수(혹은 분석 함수) | | CUME_DIST, DENSE_RANK, FIRST_VALUE, LAST_VALUE, LEAD, NTILE, RANK, ROW_NUMBER |	
---	

### 숫자 함수	
- SQL 문에서는 수학의 기본적인 사칙 연산자 (+, -, *, /)와 나머지(%) 연사자 기호를 그대로 사용	

### 숫자 함수의 종류	

| 함수 | 설명 |	
| --- | --- |	
| ABS(숫자) | 숫자의 절댓값을 계산 |	
| CEIL(숫자) | 숫자보다 크거나 같은 최소의 정수 |	
| FLOOR(숫자) | 숫자보다 작거나 같은 최소의 정수 |	
| ROUND(숫자, m) | 숫자의 반올림, m은 반올림 기준 자릿수 |	
| LOG(n, 숫자) | 숫자의 자연로그 값을 반환 |	
| POWER(숫자, n) | 숫자의 n제곱 값을 계산 |	
| SQRT(숫자) | 숫자의 제곱근 값을 계산 |	
| SIGN(숫자) | 숫자가 음수면 -1, 0이면 0, 양수면 1 |	
--- 	


### 문자 함수	
- 문자 함수는 주로 CHAR나 VARCHAR의 데이터 타입을 대상으로 단일 문자나 문자열을 가공한 결과를 반환한다.	

s : 문자열, c : 문자, n : 정수, k : 정수	
### 문자값 반환 함수	
| 함수 | 설명 |	
| --- | --- |	
| CONCAT(s1, s1) | 두 문자열을 연결 |	
| LOWER(s) | 대상 문자열을 모두 소문자로 변환 |	
| LPAD(s, n, c) | 대상 문자열의 왼쪽부터 지정한 자리수까지 지정한 문자로 채움 |	
| REPLACE(s1, s2, s3) | 대상 문자열의 왼쪽부터 지정한 자리수까지 지정한 문자로 채움 |	
| RPAD(s, n, c) | 대상 문자열의 오른쪽부터 지정한 자리수까지 지정한 문자로 채움 |	
| SUBSTR(s, n, k) | 대상 문자열의 지정된 자리에서부터 지정된 길이만큼 잘라서 반환 |	
| TRIM(c FROM s) | 대상 문자열의 양쪽에서 지정된 문자를 삭제 |	
| UPPER(s) | 대상 문자열을 모두 대문자로 변환 |	
---	

### 숫자값 반환 함수	
| 함수 | 설명 |	
| --- | --- |	
| ASCII(c) | 대상 알파벳 문자의 아스키 코드 값을 반환 |	
| LENGTH(s) | 대상 문자열의 Byte 반환 |	
| CHAR_LENGTH(s) | 문자열의 문자 수를 반환 |	
---	

### 날짜, 시간 함수	
- 데이터베이스에는 날짜를 저장하는 경우가 많아 날짜형 데이터로 저장하여 관리하면 날짜만의 연산을 손쉽게 처리할 수 있어 편리하다.	
- 날짜와 시간 부분을 나타내는 인수는 format으로 표현	

### 날짜, 시간 함수의 종류	
| 함수 | 반환형 | 설명 |	
| --- | --- | --- |	
| STR_TO_DATE(string, format) | DATE | 문자열 데이터를 날짜형으로 반환 |	
| DATE_FORMAT(data, format) | STRING | 날짜형 데이터를 문자열로 반환 |	
| ADDDATE(date, interval) | DATE | DATE 형의 날짜에서 INTERVAL 지정한 시간만큼 더함 |	
| DATE(date) | DATE | DATE 형의 날짜 부분을 반환 |	
| DATEDIFF(date1, date2) | INTEGER | DATE 형의 date1 - date2 날짜 차이를 반환 |	
| SYSDATE | DATE | DBMS 시스템상의 오늘 날짜를 반환하는 함수 |	
---	

### format의 주요 지정자(specifier)	
| 인자 | 설명                      |	
 | --- | --- |	
 | %w | 요일 순서(0~6, Sunday=0) |	
 | %W | 요일(Sunday~Saturday) |	
 | %a | 요일의 약자(Sun~Sat) |	
 | %d | 1달 중 날짜(00~31) |	
 | %j | 1년 중 날짜(001~366) |	
 | %h | 12시간(0~12) |	
 | %H | 24시간(0~24) |	
 | %i | 분(0~59) |	
 | %m | 월 순서(01~12) |	
 | %b | 월 이름 약어(Jan~Dec) |	
 | %M | 월 이름(January~December) |	
 | %s | 초(0~59) |	
 | %Y | 4자리 연도 |	
 | %y | 4자리 연도의 마지막 2자리 |	

 ### NULL 값 처리	
 - NULL 값이란 아직 지정되지 않은 값을 말한다.	
 - 특별한 값	
 - 비교 연산자로 비교 불가능	
 - 연산을 수행하면 결과 역시 NULL	

### NULL 값에 대한 연산과 집계 함수	
NULL값이 포함된 행에 대해 다음과 같은 주의가 필요하다.	

 - 'NULL+숫자' 연산의 결과는 NULL이다.	
 - 집계 함수를 계산할 때 NULL이 포함된 행은 집계에서 빠진다.	
 - 해당되는 행이 하나도 없을 경우 SUM, AVG 함수의 결과는 NULL이 되고, COUNT 함수의 결과는 0이다.	

### NULL 값을 확인하는 방법 - IS NULL, IS NOT NULL	
 - NULL값을 찾을 때는 ‘=’연산자가 아닌 ‘IS NULL’을 사용하고, NULL이 아닌 값을 찾을 때는 ‘<>’연산자가 아닌 ‘IS NOT NULL’을 사용한다.	

 ### IFNULL함수	
 - IFNULL함수는 NULL값을 다른 값으로 대치하여 연산하거나 다른 값으로 출력하는 함수이다. IFNULL함수를 사용하면 NULL값을 임의의 다른 값으로 변경할 수 있다.	
 - IFNULL(속성, 값) : 속성 값이 NULL이면 ‘값’으로 대치한다.	

### 행번호 출력	
- 변수는 이름 앞에 @ 기호를 붙이며 치환문에는 SET과 :=기호를 사용	

ex)	
```sql	
 SET @seq:=0;	
 SELECT (@seq:=@seq+1) '순번', custid, name, phone	
 FROM Customer	
 WHERE @seq<2;	
 ```	
--- 	

 ## 02 부속질의	
- 부속질의는 하나의 SQL 문 안에 다른 SQL 문이 중첩된 질의를 말한다.	
- 다른 테이블에서 가져온 데이터로 현재 테이블에 있는 정보를 찾거나 가공할 때 사용한다.	
- **조인을 사용할 경우** : Customer 테이블과 Orders 테이블의 고객번호로 조인한 후 필요한 데이터를 추출한다.	
- **부속질의를 사용할 경우** : Customer 테이블에서 박지성 고객의 고객번호를 찾고, 찾은 고객번호를 바탕으로 Orders 테이블에서 확인한다.	
- 조인보다 필요한 데이터만 찾아서 공급해주는 부속질의의 성능이 더 좋다.	

### 부속질의의 종류	
 | 명칭 | 위치 | 설명 |	
| --- | --- | --- |	
| 스칼라 부속질의 | SELECT 절 | SELECT절에서 사용되며 단일 값을 반환하기 때문에 스칼라 부속질의라고 한다 |	
| 인라인 뷰 | FROM 절 | FROM절에서 결과를 뷰 형태로 반환하기 때문에 인라인 뷰라고 한다. |	
| 중첩질의 | WHERE절 | WHERE절에 술어와 같이 사용되며 결과를 한정시키기 위해 사용된다. 상관 혹은 비상관 형태다. |	

### 스칼라 부속질의 - SELECT 부속질의	
- SELECT 절에서 사용되는 부속질의	
- 부속질의의 결과 값을 단일 행, 단일 열의 스칼라 값으로 반환한다.	

### 인라인 뷰 - FROM 부속질의	
- FROM 절에서 사용되는 부속질의	
- FROM에 테이블 대신 인라인 뷰 부속질의를 사용하면 보통의 테이블과 같은 형태로 사용할 수 있다.	
- 성능 향상	

### 중첩질의 - WHERE 부속질의	
- WHERE 절에서 사용되는 부속질의	
- WHERE 절은 보통 데이터를 선택하는 조건 혹은 술어와 같이 사용된다.	
- 연산 결과에 따라 WHERE 절의 조건이 참인지 거짓인지 확인하여 참일 경우 주질의의 해당 행을 출력한다.	

- 비교 연산자	
   - 부속질의가 단일 행, 단일 열을 반환할 때 사용 가능	

 - IN, NOT IN	
   - 주질의의 속성 값이 부속질의에서 제공한 결과 집합에 있는지 확인하는 역할	
   - IN 연산자에서 사용 가능한 부속질의는 결과로 다중 행, 다중 열을 반환할 수 있다.	

 - ALL, SOME(ANY)	
   - ALL, SOME(ANY)연산자는 비교 연산자와 함께 사용된다.	
   - ALL은 모든, SOME(ANY)는 최소한 하나라는 의미를 가진다.	

 - EXISTS, NOT EXISTS	
   - 데이터의 존재 유무를 확인하는 연산자이다.	
   - 부속질의에 조건을 만족하여 값이 존재하면 참이 되고, 주질의는 해당 행의 데이터를 출력한다.	
---	

## 03 뷰	
- 하나 이상의 테이블을 합하여 만든 가상의 테이블	
- 실제 테이블처럼 사용할 수 있음	
- 뷰는 사상의 테이블로, 실제 데이터를 디스크에 저장하지 않고 단지 뷰를 생성할 때 사용한 SLECT문의 정의를 DBMS가 저장한다.	

### 뷰의 장점	
  - **편리성 및 재사용성** : 미리 정의된 뷰를 일반 테이블처럼 사용할 수 있기 때문에 편리하다. 자주 사용되는 질의를 뷰로 미리 정의해 재사용할 수 있다.	
   - **보안성** : 사용자별로 보안이 필요한 데이터를 제외하여 선별하여 보여줄 수 있다.	
   - **독립성** : 원본 테이블의 구조가 변해도 응용 프로그램에 영향을 주지 않도록 하는 논리적 독립성을 제공하는 방법이다.	

### 뷰의 생성	
```sql	
CREATE VIEW 뷰이름[(열이름 [,... n])]	
AS SELECT 문	
```	

### 뷰의 수정	
```sql	
 CREATE OR REPLACE VIEW 뷰이름 [(열이름[,... n])]	
 AS SELECT 문	
 ```	

### 뷰의 삭제	
 ```sql	
 DROP VIEW 뷰이름[,... n];	
 ```	
--- 	

 ## 04 인덱스	
액세스 시간 = 탐색시간(액세스 헤드를 트랙에 이동시키는 시간) + 회전 지연시간(섹터가 액세스 해드에 접근하는 시간) + 데이터 전송시간(데이터를 주기억장치로 읽어오는 시간)	
- 이러한 속도 문제를 줄이기 위해 주기억장치에 DBMS가 사용하는 공간 중 일부를 버퍼 풀로 만들어 사용하는 방법이 있다. DB는 버퍼에 자주 사용하는 데이터를 저장해주며 LRU 알고리즘을 이용하여 사용빈도가 높은 데이터 위주로 저장하고 관리한다.	
- 데이터 검색 시 DBMS는 버퍼 풀에 저장된 데이터를 우선 읽어 들인 후 작업을 진행한다.	

### 인덱스와 B-Tree	
인덱스	
- 자료를 쉽고 빠르게 찾을 수 있도록 만든 데이터 구조	
- 원하는 데이터를 빨리 찾기 위해 투플의 키 값에 대한 물리적 위치를 기록해둔 자료구조	
- 일반적인 RDBMS의 인덱스는 대부분 B-Tree 구조	

B-Tree	
- 데이터의 검색 시간을 단축하기 위한 자료구조	
- 루트 노드, 내부 노드, 리프 노드로 구성되며, 리프 노드가 모두 같은 레벨에 존재하는 균형 트리	

### 인덱스의 특징	
- 인덱스는 테이블에서 한 개 이상의 속성을 이용하여 생성한다.	
- 빠른 검색과 함께 효율적인 레코드 접근이 가능하다.	
- 순서대로 정렬된 속성과 데이터의 위치만 보유하므로 테이블보다 작은 공간을 차지한다.	
- 저장된 값들은 테이블의 부분집합이 된다.	
- 일반적으로 B-tree 형태의 구조를 가진다.	
- 데이터의 수정, 삭제 등의 변경이 발생하면 인덱스의 재구성이 필요하다.	

### MYSQL 인덱스	
- 클러스터 인덱스와 보조 인덱스가 보통 같이 사용된다.	

### MYSQL 인덱스의 종류	
 | 인덱스 명칭 | 설명 |	
 | --- | --- |	
 | 클러스터 인덱스 | - 기본적인 인덱스로 테이블 생성 시 기본키를 지정하면 기본 키에 대하여 클러스터 인덱스를 생성한다. <br> - 기본키를 지정하지 않으면 먼저 나오는 UNIQUE 속성에 대하여 클러스터 인덱스를 생성한다. <br> - 기본키나 UNIQUE 속성이 없는 테이블은 MySQL이 자체 생성한 행 번호를 이용하여 클러스터 인덱스를 생성한다. |	
   | 보조 인덱스 | - 클러스터 인덱스가 아닌 모든 인덱스는 보조 인덱스이며 보조 인덱스의 각 레코드는 보조 인덱스 속성과 기본키 속성 값을 갖고있다. <br> - 보조 인덱스를 검색하여 기본키 속성 값을 찾은 다음 클러스터 인덱스로 가서 해당 레코드를 찾는다. |	
---	

### 인덱스의 생성	
- 인덱스는 WHERE절에 자주 사용되는 속성이어야 한다.	
- 인덱스는 조인에 자주 사용되는 속성이어야 한다.	
- 단일 테이블에 인덱스가 많으면 속도가 느려질 수 있다(테이블 당 4~5개 정도 권장).	
- 속성이 가공되는 경우 사용하지 않는다.	
- 속성의 선택도가 낮을 때 유리하다(속성의 모든 값이 다른 경우).	

```sql	
 CREATE [UNIQUE] INDEX [인덱스이름]	
 ON 테이블이름 (컬럼 [ASC | DESC] [{, 컬럼 [ASC | DESC]} ...])[;]	
 ```	

- 생성된 SHOW INDEX 명령어로 확인할 수 있다.	

### 인덱스의 재구성과 삭제	
- 인덱스의 재구성은 ANALYZE TABLE 명령을 사용하여 수행한다.	
 ```sql	
 ANALYZE TABLE 테이블이름;	
 ```	

 - 인덱스의 삭제는 DROP INDEX 명령을 사용한다.	
 ```sql	
 DROP INDEX ix Book ON Book;	
 ```
