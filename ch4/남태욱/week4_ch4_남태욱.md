# CHAPTER 04 SQL 고급

## 1. 내장 함수(built-in function)

- DBMS가 제공하는 함수
- 내장 함수외에도 사용자가 직접 만드는 사용자 정의 함수(user-defined function)이 있다.

### SQL 내장 함수

- SQL 내장 함수는 SELECT 절과 WHERE 절, UPDATE 절 등에서 모두 사용 가능하다.

#### 숫자 함수

- SQL은 +, -, *, /, % 등의 기본 연산자들을 사용한다.
- 기본 연산자들 이외의 다른 연산들은 내장 함수 형태로 제공된다.

|   함수    |           설명            |
|:-------:|:-----------------------:|
|   ABS   |         절댓값 계산          |
|  CEIL   |    크거나 같은 최소의 정수(올림)    |
|  FLOOR  |    작거나 같은 최소의 정수(내림)    |
|  ROUND  |           반올림           |
|   LOG   |          자연로그           |
|  POWER  |          n제곱 값          |
|  SQRT   |          제곱근 값          |
|  SIGN   | 음수면 -1, 0이면 0, 양수면 1 반환 |

#### 문자 함수(Character Functions)

- CHAR이나 VARCHAR등의 데이터 타입들을 대상으로 단일 문자나 문자열을 가공한다.

|   반환 구분    |      함수      |                         설명                         |
|:----------:|:------------:|:--------------------------------------------------:|
| 문자값 반환 함수  |    CONCAT    |                     두 문자열을 연결                      |
|            |    LOWER     |                 대상 문자열을 모두 소문자로 변환                 |
|            |     LPAD     |         대상 문자열의 왼쪽부터 지정한 자리수까지 지정한 문자로 채움          |
|            |   REPLACE    |             대상 문자열의 지정한 문자를 원하는 문자로 변경             |
|            |     RPAD     |         대상 문자열의 오른쪽부터 지정한 자리수까지 지정한 문자로 채움         |
|            |    SUBSTR    |        대상 문자열의 지정된 자리에서부터 지정된 길이 만큼 잘라서 반환         |
|            |     TRIM     | 대상 문자열의 양쪽에서 지정된 문자를 삭제<br>(문자열만 넣으면 기본값으로 공백 제거)  |
|            |    UPPER     |                 대상 문자열을 모두 대문자로 변환                 |
| 숫자값 반환 함수  |    ASCII     |              대상 알파벳 문자의 아스키 코드 값을 반환               |
|            |    LENGTH    |    대상 문자열의 Byte 반환, 알파벳 1byte, 한글 3byte (UTF8)     |
|            | CHAR_LENGTH  |                   문자열의 문자 수를 반환                    |

#### 날짜, 시간 함수

- 데이터베이스에 날짜와 시간을 저장하기 위해 사용
- 날짜와 시간 부분을 나타내는 인수는 format으로 표기

| 함수 | 반환형 | 설명 |
| --- | --- | --- |
| STR_TO_DATE(string, format) | DATE | 문자열(STRING) 데이터를 날짜형(DATE)으로 반환 |
| DATE_FORMAT(date, format) | STRING | 날짜형(DATE) 데이터를 문자열 (VARCHAR)로 반환 |
| ADDDATE(date, interval) | DATE | DATE 형의 날짜에서 INTERVAL 지정한 시간만큼 더함 |
| DATE(date) | DATE | DATE 형의 날짜 부분을 반환 |
| DATEDIFF(date1, date2) | INTEGER | DATE 형의 date1 - date2 날짜 차이를 반환 |
| SYSDATE | DATE | DBMS 시스템상의 오늘 날짜를 반환하는 함수 |

- 날짜형 데이터는 -와 +를 사용하여 원하는 날짜로부터 이전(-)과 이후(+)를 계산할 수 있다.

##### format의 주요 지정자

| 인자 | 설명 |
|:---:|:---:|
| %w | 요일 순서(0~6, Sunday=0) |
| %W | 요일(Sunday~Saturday) |
| %a | 요일의 약자(Sun~Sat) |
| %d | 1 달 중 날짜(00~31) |
| %j | 1 년 중 날짜(001~366) |
| %h | 12시간(01~12) |
| %H | 24시간(00~23) |
| %i | 분(0~59) |
| %m | 월 순서(01~12, January=01) |
| %b | 월 이름 약어(Jan~Dec) |
| %M | 월 이름(January~December) |
| %s | 초(0~59) |
| %Y | 4자리 연도 |
| %y | 4자리 연도의 마지막 2 자리 |

#### NULL 값 처리

- NULL 값은 아직 지정되지 않은 값을 뜻함
- NULL 값은 '0', ''(공백문자), ' '(공백)등과 다른 값이다.
- NULL 값은 비교 연산자로 비교가 불가능하다.

##### NULL 값에 대한 연산과 집게 함수

- NULL + 숫자 연산의 결과는 NULL이다.
- 집계 함수를 계산할 때 NULL이 포함된 행은 집계에서 빠진다.
- 해당되는 행이 하나도 없을 경우 SUM, AVG 함수의 결과는 NULL이 되고, COUNT 함수의 결과는 0이 된다.

##### IS NULL, IS NOT NULL

- NULL 값을 찾을 때는 '=' 연산자가 아닌 'IS NULL'을 사용한다.

##### IFNULL 함수

```mysql
IFNULL(속성, 값)
```

- 속성 값이 NULL 이면 값으로 대치한다.

## 2. 부속질의(subquery)

- 하나의 SQL 문 안에 다른 SQL 문이 중첩된 질의를 말한다.
- 부속질의는 주질의(main query)와 부속질의(subquery)로 구성된다.
- 주질의는 외부질의, 부속질의는 내부질의라고도 부른다.

### 부속질의의 종류

|     명칭      |     위치     |               영문 및 동의어               |                            설명                            |
|:-----------:|:----------:|:------------------------------------:|:--------------------------------------------------------:|
|  스칼라 부속질의   |  SELECT 절  |           scalar subquery            |      SELECT 절에서 사용되며 단일 값을 반환하기 때문에 스칼라 부속질의라고 한다.       |
|    인라인 뷰    |   FROM 절   |     inline view, table subquery      |      FROM 절에서 결과를 뷰(View) 형태로 반환하기 때문에 인라인 뷰라고 한다.       |
|    중첩질의     |  WHERE 절   | nested subquery, predicate subquery  |  WHERE 절에 술어와 같이 사용되며 결과를 한정시키기 위해 사용된다. 상관 혹인 비상관 형태다.  |

### 스칼라 부속질의 - SELECT 부속질의

- SELECT 절에서 사용되는 부속질의
- 결과 값을 단일 행, 단일 열의 스칼라 값으로 반환
- 결과 값이 다중 행이거나 다중 열이라면 에러 발생
- 주질의와 부속질의의 관계는 상관과 비상관 모두 가능

### 인라인 뷰 - FROM 부속질의

- FROM 절에서 사용되는 부속질의
- FROM 절에 테이블 이름 대신 인라인 뷰 부속질의를 사용
- 다중 행, 다중 열이어도 사용 가능하다.
- 가상 테이블인 뷰 형태로 제공되기 때문에 상관 부속질의로 사용될 수는 없다.

### 중첩질의 - WHERE 부속질의

- WHERE 절에서 사용되는 부속질의
- 연산자와 함께 사용

#### 중첩질의 연산자의 종류

| 술어 | 연산자 | 반환 행 | 반환 열 | 상관 |
|:---:|:---:|:---:|:---:|:---:|
| 비교 | =, >, <. >=, <=, <> | 단일 | 단일 | 가능 |
| 집합 | IN, NOT IN | 다중 | 다중 | 가능 |
| 한정 | ALL, SOME(ANY) | 다중 | 단일 | 가능 |
| 존재 | EXISTS, NOT EXISTS | 다중 | 다중 | 필수 |

## 3. 뷰

- 하나 이상의 테이블을 합하여 만든 가상의 테이블
- 뷰는 테이블처럼 사용할 수 있지만, SELECT 문을 제외한 일부 물리적인 테이블의 갱신작업을 수행하는데 제약이 있다.

### 뷰의 장점

- 편리성 및 재사용성 : 사용자가 필요로 하는 정보만 요구에 맞게 가공해서 사용 가능함
- 보안성 : 각 사용자별로 보안이 필요한 데이터를 제외하여 선별하여 보여줄 수 있음
- 독립성 : 논리 데이터베이스의 원본 테이블 구조가 변해도 응용 프로그램에 영향을 주지 않도록 할 수 있음

### 뷰의 생성

```mysql
CREATE VIEW 뷰이름[(열이름 [,... n])]
AS SELECT 문
```

### 뷰의 수정

```sql
CREATE OR REPLACE VIEW 뷰이름 [(열이름 [,... n])]
AS SELECT 문
```

- CREATE VIEW 문에 OR REPLACE 명령을 더하여 작성한다.

### 뷰의 삭제

```mysql
DROP VIEW 뷰이름 [(열이름 [,... n])];
```

## 4. 인덱스

- 컴퓨터의 데이터 연산 속도에 비해 하드디스크의 데이터 엑세스 속도가 느리기 때문에 버퍼 풀(buffer pool memory)등을 사용한다.
- 데이터베이스는 버퍼에 자주 사용하는 데이터를 저장해고, LRU(least recently used) 알고리즘을 이용하여 사용 빈도가 높은 데이터 위주로 저장하고 관리한다.

### 인덱스와 B-tree

- 데이터를 빠르게 찾을 수 있도록 만들어진 데이터 구조
- 일반적인 데이터베이스의 인덱스는 대부분 B-tree 구조로 되어있다.

#### B-tree의 특징

- 루트 노드, 내부 노드, 리프 노드로 구성됨
- 리프 노드가 모두 같은 레벨에 존재하는 균형 트리
- 각 노드가 키 값과 포인터를 가진다.
- 키 값은 오름차순으로 저장된다.

#### MySQL 인덱스

- 클러스터 인덱스(clustered index)와 보조 인덱스(secondary index)로 나뉘어진다.

##### 클러스터 인덱스

- 테이블당 하나만 생성 가능
- 키 값에 의한 동등 및 범위 검색 모두에 유리
- 인덱스 저장 시 차지하는 공간이 적음
- 테이블 생성 시 기본키를 생성하면 자동으로 생성됨

##### 보조 인덱스

- 한 테이블에 여러 개 생성 가능
- 하나의 컬럼을 대상으로 하는 단일 컬럼 인덱스 뿐만 아니라 여러 개의 컬럼을 복합적으로 결합하여 사용하는 인덱스도 만들 수 있다.

#### 인덱스의 생성

##### 인덱스 생성 시 고려사항

- 인덱스는 WHERE 절에 자주 사용되는 속성이어야 한다.
- 인덱스는 조인에 자주 사용되는 속성이어야 한다.
- 단일 테이블에 인덱스가 많으면 속도가 느려질 수 있다.(테이블 당 4~5개 정도 권장)
- 속성이 가공되는 경우 사용하지 않는다.
- 속성의 선택도가 낮을 때 유리하다(속성의 모든 값이 다른 경우)

##### 인덱스 생성 문법

```mysql
CREATE [UNIQUE] INDEX [인덱스이름]
ON 테이블이름 (컬럼 [ASC | DESC] [{, 컬럼 [ASC | DESC]} ...])[;]
```

#### 인덱스의 재구성과 삭제

##### 인덱스의 재구성

```mysql
ANALYZE TABLE 테이블이름;
```

- ANALYZE TABLE 명령을 사용하여 수행

##### 인덱스의 삭제

```mysql
DROP INDEX 테이블이름;
```

- DROP INDEX 명령을 사용하여 수행
